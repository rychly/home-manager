[[ch-writing-modules]]
== Writing Home Manager Modules
:writing-nixos-modules: https://nixos.org/nixos/manual/index.html#sec-writing-modules

The module system in Home Manager is based entirely on the NixOS module system so we will here only highlight aspects that are specific for Home Manager. For information about the module system as such please refer to the {writing-nixos-modules}[Writing NixOS Modules] chapter of the NixOS manual.

[[sec-option-types]]
=== Option Types
:wikipedia-dag: https://en.wikipedia.org/w/index.php?title=Directed_acyclic_graph&oldid=939656095
:gvariant-description: https://developer.gnome.org/glib/stable/glib-GVariant.html#glib-GVariant.description

Overall the basic option types are the same in Home Manager as NixOS. A few Home Manager options, however, make use of custom types that are worth describing in more detail. These are the option types `dagOf` and `gvariant` that are used, for example, by <<opt-programs.ssh.matchBlocks>> and <<opt-dconf.settings>>.

`hm.types.dagOf`::
Options of this type have attribute sets as values where each attribute is a node in a {wikipedia-dag}[directed acyclic graph] (DAG). This allows the attribute set entries to express dependencies relations among themselves. This can, for example, be used to control the order of match blocks in a OpenSSH client configuration.
+
A number of functions are provided to create DAG nodes. The functions are shown below with examples using an option `foo.bar`  of type `hm.types.dagOf types.int`.
+
`hm.dag.entryAnywhere (value: T)`:::
Indicates that `value` can be placed anywhere within the DAG. This is also the default for plain attribute set entries, that is
+
[source,nix]
----
foo.bar = {
  a = hm.dag.entryAnywhere 0;
}
----
+
and
+
[source,nix]
----
foo.bar = {
  a = 0;
}
----
+
are equivalent.
+
`hm.dag.entryAfter (afters: list string) (value: T)`:::
Indicates that `value` must be placed _after_ each of the attribute names in the given list. For example
+
[source,nix]
----
foo.bar = {
  a = 0;
  b = hm.dag.entryAfter [ "a" ] 1;
}
----
+
would place `b` after `a` in the graph.
+
`hm.dag.entryBefore (befores: list string) (value: T)`:::
Indicates that `value` must be placed _before_ each of the attribute names in the given list. For example
+
[source,nix]
----
foo.bar = {
  b = hm.dag.entryBefore [ "a" ] 1;
  a = 0;
}
----
+
would place `b` before `a` in the graph.
+
`hm.dag.entryBetween (befores: list string) (afters: list string) (value: T)`:::
Indicates that `value` must be placed _before_ the attribute names in the first list and _after_ the attribute names in the second list. For example
+
[source,nix]
----
foo.bar = {
  a = 0;
  c = hm.dag.entryBetween [ "b" ] [ "a" ] 2;
  b = 1;
}
----
+
would place `c` before `b` and after `a` in the graph.

`hm.types.gvariant`::
This type is useful for options representing {gvariant-description}[GVariant] values. The type accepts all primitive GVariant types as well as arrays and tuples. Dictionaries are not currently supported.
+
To create a GVariant value you can use a number of provided functions. In the lists below `gvariant.value` indicates GVariant values represented in Nix and `gvariant.type` indicates GVariant types, also represented in Nix.
+
`hm.gvariant.mkBoolean: bool → gvariant.value`:::
Takes a Nix value to a GVariant `boolean` value.
`hm.gvariant.mkString: string → gvariant.value`:::
Takes a Nix value to a GVariant `string` value.
`hm.gvariant.mkObjectpath: string → gvariant.value`:::
Takes a Nix value to a GVariant `objectpath` value.
`hm.gvariant.mkUchar: string → gvariant.value`:::
Takes a Nix value to a GVariant `uchar` value.
`hm.gvariant.mkInt16: int → gvariant.value`:::
Takes a Nix value to a GVariant `int16` value.
`hm.gvariant.mkUint16: int → gvariant.value`:::
Takes a Nix value to a GVariant `uint16` value.
`hm.gvariant.mkInt32: int → gvariant.value`:::
Takes a Nix value to a GVariant `int32` value.
`hm.gvariant.mkUint32: int → gvariant.value`:::
Takes a Nix value to a GVariant `uint32` value.
`hm.gvariant.mkInt64: int → gvariant.value`:::
Takes a Nix value to a GVariant `int64` value.
`hm.gvariant.mkUint64: int → gvariant.value`:::
Takes a Nix value to a GVariant `uint64` value.
`hm.gvariant.mkDouble: double → gvariant.value`:::
Takes a Nix value to a GVariant `double` value.
+
`hm.gvariant.mkArray: (elemType: gvariant.type) → (elems: list (t: elemType)) → gvariant.value`:::
Builds a GVariant array containing the given list of elements. The `elemType` value can be constructed using
+
--
- `hm.gvariant.type.string: gvariant.type`
- `hm.gvariant.type.boolean: gvariant.type`
- `hm.gvariant.type.uchar: gvariant.type`
- `hm.gvariant.type.int16: gvariant.type`
- `hm.gvariant.type.uint16: gvariant.type`
- `hm.gvariant.type.int32: gvariant.type`
- `hm.gvariant.type.uint32: gvariant.type`
- `hm.gvariant.type.int64: gvariant.type`
- `hm.gvariant.type.uint64: gvariant.type`
- `hm.gvariant.type.double: gvariant.type`
- `hm.gvariant.type.arrayOf: gvariant.type → gvariant.type`
- `hm.gvariant.type.tupleOf: list gvariant.type → gvariant.type`
--
+
and `elems` is a list of GVariant values. The list elements must all be of the type `elemType`.
+
`hm.gvariant.mkEmptyArray: gvariant.type → gvariant.value`:::
An alias of `hm.gvariant.mkArray elemType []`.
+
`hm.gvariant.mkTuple: list gvariant.type → gvariant.value`:::
Builds a GVariant tuple containing the given list of elements.
